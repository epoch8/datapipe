# Offset Optimization - Edge Case Tests

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç—ã –¥–ª—è edge cases –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ offset optimization.

## üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ

### test_offset_invariants.py
–¢–µ—Å—Ç—ã –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ offset optimization:
- `test_offset_invariant_synchronous` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç–∏ offset –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
- `test_offset_invariant_concurrent` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥–æ–≤)
- `test_offset_with_delayed_records` - —Å—Ü–µ–Ω–∞—Ä–∏–π —Å "–∑–∞–ø–æ–∑–¥–∞–ª—ã–º–∏" –∑–∞–ø–∏—Å—è–º–∏

### test_offset_first_run_bug.py
–¢–µ—Å—Ç—ã –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:
- `test_first_run_with_mixed_update_ts_and_order_by_id` - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å mixed update_ts
- `test_first_run_invariant_all_records_below_offset_must_be_processed` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞

### test_offset_production_bug.py
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã production –±–∞–≥–æ–≤ (edge cases):
- `test_offset_skips_records_with_intermediate_transformation` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è
- `test_offset_with_non_temporal_ordering` - ORDER BY –ø–æ id –≤–º–µ—Å—Ç–æ update_ts
- `test_process_ts_vs_update_ts_divergence` - —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ process_ts –∏ update_ts
- `test_copy_to_online_with_stats_aggregation_chain` - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã offset optimization

### –ì–ª–∞–≤–Ω—ã–π production —Ç–µ—Å—Ç
**–§–∞–π–ª:** `tests/test_offset_production_bug_main.py`

–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç production –±–∞–≥ (–ø–æ—Ç–µ—Ä—è 60% –¥–∞–Ω–Ω—ã—Ö):
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∫–ª—é—á–µ–≤–æ–π –±–∞–≥ (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö —Å update_ts == offset)
- ‚úÖ –ò–º–µ–µ—Ç —á–µ—Ç–∫—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

### –¢–µ—Å—Ç—ã –≥–∏–ø–æ—Ç–µ–∑
**–§–∞–π–ª—ã:**
- `tests/test_offset_hypotheses.py` - –≥–∏–ø–æ—Ç–µ–∑—ã 1, 2 –∏ –∞–Ω—Ç–∏—Ä–µ–≥—Ä–µ—Å—Å–∏—è
- `tests/test_offset_hypothesis_3_multi_step.py` - –≥–∏–ø–æ—Ç–µ–∑–∞ 3 (multi-step pipeline)

–ü—Ä–æ–≤–µ—Ä—è—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –±–∞–≥–∞:

1. **–ì–∏–ø–æ—Ç–µ–∑–∞ 1** (–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê): –°—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ `>` –≤–º–µ—Å—Ç–æ `>=`
2. **–ì–∏–ø–æ—Ç–µ–∑–∞ 2** (–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê): ORDER BY transform_keys –≤–º–µ—Å—Ç–æ update_ts
3. **–ì–∏–ø–æ—Ç–µ–∑–∞ 3** (–û–ü–†–û–í–ï–†–ì–ù–£–¢–ê): –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ multi-step pipeline
4. **–ì–∏–ø–æ—Ç–µ–∑–∞ 4** (–û–ü–†–û–í–ï–†–ì–ù–£–¢–ê): "–ó–∞–ø–æ–∑–¥–∞–ª—ã–µ" –∑–∞–ø–∏—Å–∏

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [../docs/offset_fix_plans/](../../docs/offset_fix_plans/)

## üîç –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å edge case —Ç–µ—Å—Ç—ã

–≠—Ç–∏ —Ç–µ—Å—Ç—ã –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è:
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –û—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å offset optimization
- –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ú–Ω–æ–≥–∏–µ —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ –∏–º–µ—é—Ç `@pytest.mark.xfail` –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ edge cases –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.

### –°–≤—è–∑—å —Å –≥–∏–ø–æ—Ç–µ–∑–∞–º–∏

Edge case —Ç–µ—Å—Ç—ã –≤ —ç—Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ –±—ã–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω—ã **–¥–æ** —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≥–∏–ø–æ—Ç–µ–∑. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö:
- `test_offset_with_non_temporal_ordering` - —Å–≤—è–∑–∞–Ω —Å **–≥–∏–ø–æ—Ç–µ–∑–æ–π 2** (ORDER BY)
- `test_process_ts_vs_update_ts_divergence` - —Å–≤—è–∑–∞–Ω —Å **–≥–∏–ø–æ—Ç–µ–∑–æ–π 3** (—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
- `test_offset_with_delayed_records` - —Å–≤—è–∑–∞–Ω —Å **–≥–∏–ø–æ—Ç–µ–∑–æ–π 4** ("–∑–∞–ø–æ–∑–¥–∞–ª—ã–µ" –∑–∞–ø–∏—Å–∏)

**–ù–û:** –≠—Ç–∏ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `step.run_full(ds)` –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫, –ø–æ—ç—Ç–æ–º—É **–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±–∞–≥–∏ –Ω–µ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è**.

–î–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–∏–ø–æ—Ç–µ–∑ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã** –∏–∑ `tests/test_offset_hypotheses.py` –∏ `tests/test_offset_hypothesis_3_multi_step.py`.

---

**–°–º. —Ç–∞–∫–∂–µ:**
- [–û—Å–Ω–æ–≤–Ω–æ–π README —Ç–µ—Å—Ç–æ–≤](../README.md)
- [–ü–ª–∞–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π](../../docs/offset_fix_plans/README.md)
