# –ü–ª–∞–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Offset Optimization Bug

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ø–ª–∞–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º offset optimization, –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ production (08.12.2025).

## Production –∏–Ω—Ü–∏–¥–µ–Ω—Ç

- **–î–∞—Ç–∞:** 08.12.2025
- **–ü–æ—Ç–µ—Ä—è–Ω–æ:** 48,915 –∏–∑ 82,000 –∑–∞–ø–∏—Å–µ–π (60%)
- **–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –≤ offset optimization
- **–°—Ç–∞—Ç—É—Å –¥–∞–Ω–Ω—ã—Ö:** –ù–∞ 11.12.3025 –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º v1

## –ì–∏–ø–æ—Ç–µ–∑—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ì–∏–ø–æ—Ç–µ–∑–∞ 1: –°—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ `update_ts > offset`
**–°—Ç–∞—Ç—É—Å:** –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** (2025-12-12)
**–§–∞–π–ª:** [hypothesis_1_strict_inequality.md](hypothesis_1_strict_inequality.md)

**–ü—Ä–æ–±–ª–µ–º–∞:** `WHERE update_ts > offset` —Ç–µ—Ä—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å `update_ts == offset`

**–¢–µ—Å—Ç:** `tests/test_offset_hypotheses.py::test_hypothesis_1_strict_inequality_loses_records_with_equal_update_ts`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
1. –ò–∑–º–µ–Ω–∏—Ç—å `>` –Ω–∞ `>=` –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö offset (5 –º–µ—Å—Ç)
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `process_ts` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `update_ts IS NULL` –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ error_records

---

### ‚úÖ –ì–∏–ø–æ—Ç–µ–∑–∞ 2: ORDER BY transform_keys –≤–º–µ—Å—Ç–æ update_ts
**–°—Ç–∞—Ç—É—Å:** –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** (2025-12-11)
**–§–∞–π–ª:** [hypothesis_2_order_by_keys.md](hypothesis_2_order_by_keys.md)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞—Ç—á–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ `transform_keys`, –Ω–æ `offset = MAX(update_ts)`. –ó–∞–ø–∏—Å–∏ —Å `id` –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π, –Ω–æ —Å `update_ts < offset` —Ç–µ—Ä—è—é—Ç—Å—è.

**–¢–µ—Å—Ç:** `tests/test_offset_hypotheses.py::test_hypothesis_2_order_by_transform_keys_with_mixed_update_ts`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞—Ç—á–∏ –ø–æ `update_ts` (—Å–Ω–∞—á–∞–ª–∞), –∑–∞—Ç–µ–º –ø–æ `transform_keys` (–¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞)
- –î–æ–±–∞–≤–∏—Ç—å `.nullslast()` - error_records –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏

---

### ‚ùå –ì–∏–ø–æ—Ç–µ–∑–∞ 3: –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è update_ts –∏ process_ts –≤ multi-step pipeline
**–°—Ç–∞—Ç—É—Å:** –û–ü–†–û–í–ï–†–ì–ù–£–¢–ê
**–§–∞–π–ª:** [hypothesis_3_multistep_desync.md](hypothesis_3_multistep_desync.md)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É `update_ts` (–≤—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã) –∏ `process_ts` (–º–µ—Ç–∞-—Ç–∞–±–ª–∏—Ü—ã –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏) –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å offset optimization.

**–¢–µ—Å—Ç:** `tests/test_offset_hypothesis_3_multi_step.py::test_hypothesis_3_multi_step_pipeline_update_ts_vs_process_ts_desync`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–æ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `process_ts` –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–∞ –¥–ª—è –≥–∏–ø–æ—Ç–µ–∑—ã 1, –Ω–æ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –°–í–û–ï–ì–û process_ts, –∞ –Ω–µ –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.

---

### ‚ùå –ì–∏–ø–æ—Ç–µ–∑–∞ 4: "–ó–∞–ø–æ–∑–¥–∞–ª–∞—è" –∑–∞–ø–∏—Å—å —Å update_ts < offset
**–°—Ç–∞—Ç—É—Å:** –û–ü–†–û–í–ï–†–ì–ù–£–¢–ê (–∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞)
**–§–∞–π–ª:** [hypothesis_4_delayed_records.md](hypothesis_4_delayed_records.md)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `store_chunk()` –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (`time.time()`) –¥–ª—è `update_ts`. "–ó–∞–ø–æ–∑–¥–∞–ª—ã–µ" –∑–∞–ø–∏—Å–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ.

**–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞:**
- `datapipe/datatable.py:59` - store_chunk
- `datapipe/meta/sql_meta.py:256-257` - if now is None: now = time.time()

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–±–ª–æ–∫–∏—Ä—É–µ—Ç production)

1. **–ì–∏–ø–æ—Ç–µ–∑–∞ 1** - –°—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ~50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
   - –†–∏—Å–∫: —Å—Ä–µ–¥–Ω–∏–π (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ process_ts)
   - –¢–µ—Å—Ç—ã: test_hypothesis_1, test_antiregression

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–±–ª–æ–∫–∏—Ä—É–µ—Ç production)

2. **–ì–∏–ø–æ—Ç–µ–∑–∞ 2** - ORDER BY
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 1 —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞ (–ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —á—Ç–æ –≥–∏–ø–æ—Ç–µ–∑–∞ 1 —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
   - –†–∏—Å–∫: –Ω–∏–∑–∫–∏–π (–∏–∑–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
   - –¢–µ—Å—Ç—ã: test_hypothesis_2

### –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

3. **–ì–∏–ø–æ—Ç–µ–∑–∞ 3** - –û–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç–∞
4. **–ì–∏–ø–æ—Ç–µ–∑–∞ 4** - –û–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç–∞

## –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```
1. –ì–∏–ø–æ—Ç–µ–∑–∞ 1 (—Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ + process_ts)
   ‚Üì
2. –ì–∏–ø–æ—Ç–µ–∑–∞ 2 (ORDER BY update_ts)
   ‚Üì
3. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
   ‚Üì
4. Production deployment
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏:
- ‚úÖ `test_hypothesis_1_strict_inequality_loses_records_with_equal_update_ts`
- ‚úÖ `test_hypothesis_2_order_by_transform_keys_with_mixed_update_ts`
- ‚úÖ `test_antiregression_no_infinite_loop_with_equal_update_ts`
- ‚úÖ `test_production_bug_offset_loses_records_with_equal_update_ts`
- ‚úÖ `test_hypothesis_3_multi_step_pipeline_update_ts_vs_process_ts_desync`

### –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞:
```bash
pytest tests/test_offset_hypotheses.py tests/test_offset_production_bug_main.py tests/test_offset_hypothesis_3_multi_step.py -v
```

## –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–í–ï–†–®–ï–ù–´ (2025-12-12)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ | –†–µ–∑—É–ª—å—Ç–∞—Ç | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------------------|-----------|------------|
| –ì–∏–ø–æ—Ç–µ–∑–∞ 1 | ‚úÖ PASSED | –°—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –ì–∏–ø–æ—Ç–µ–∑–∞ 2 | ‚úÖ PASSED | ORDER BY –∏—Å–ø—Ä–∞–≤–ª–µ–Ω |
| Antiregression | ‚úÖ PASSED | –ù–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è |
| Production bug | ‚úÖ PASSED | 60% –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã |
| –ì–∏–ø–æ—Ç–µ–∑–∞ 3 | ‚úÖ PASSED | –û–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç–∞ |
| **–í—Å–µ offset optimization —Ç–µ—Å—Ç—ã** | ‚úÖ **15/15 PASSED** | –í–∫–ª—é—á–∞—è retry –æ—à–∏–±–æ–∫ |

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `datapipe/meta/sql_meta.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ offset optimization v2
- `tests/test_offset_hypotheses.py` - —É–±—Ä–∞–Ω—ã `@pytest.mark.xfail`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã
- `tests/test_offset_production_bug_main.py` - —É–±—Ä–∞–Ω `@pytest.mark.xfail`
- `tests/test_build_changed_idx_sql_v2.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –æ–∂–∏–¥–∞–Ω–∏—è
- `docs/offset_fix_plans/*.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
1. üéØ Production –±–∞–≥ —Å –ø–æ—Ç–µ—Ä–µ–π 60% –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω—ë–Ω
2. üìä –í—Å–µ 15 —Ç–µ—Å—Ç–æ–≤ offset optimization –ø—Ä–æ—Ö–æ–¥—è—Ç
3. üßπ –ö–æ–¥ —É–ø—Ä–æ—â—ë–Ω (~40 —Å—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ)
4. ‚úÖ Error records –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
5. üîÑ –ù–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è –ø—Ä–∏ `>=` offset

**–ì–æ—Ç–æ–≤–æ –∫ production deployment** ‚úÖ

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–≥ —Ä–µ–ø–æ—Ä—Ç:** `tests/README.md`
- **–¢–µ—Å—Ç—ã:** `tests/test_offset_*.py`
- **–ö–æ–¥ offset optimization:** `datapipe/meta/sql_meta.py` (build_changed_idx_sql_v2)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 2025-12-11
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 2025-12-12
