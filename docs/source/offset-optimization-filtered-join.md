# Filtered Join ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –∫–æ–¥–µ:** `datapipe/step/batch_transform.py:632-686`

[‚Üê –ù–∞–∑–∞–¥ –∫ –æ–±–∑–æ—Ä—É](./offset-optimization.md)

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ß—Ç–µ–Ω–∏–µ –≤—Å–µ–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ:

```
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: 100 –ø–æ—Å—Ç–æ–≤ –æ—Ç 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ profiles: 10,000,000 –∑–∞–ø–∏—Å–µ–π

–ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: —á–∏—Ç–∞–µ–º –≤—Å–µ 10 –º–ª–Ω –ø—Ä–æ—Ñ–∏–ª–µ–π
–ù—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ: 10 –ø—Ä–æ—Ñ–∏–ª–µ–π

–ü—Ä–æ–±–ª–µ–º–∞: 99.9999% –¥–∞–Ω–Ω—ã—Ö —á–∏—Ç–∞–µ—Ç—Å—è –∑—Ä—è!
```

---

## –†–µ—à–µ–Ω–∏–µ: Filtered Join

**Filtered join** ‚Äî —á–∏—Ç–∞—Ç—å –∏–∑ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –±–∞—Ç—á–∞.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–®–∞–≥ 1: –ò–∑–≤–ª–µ—á—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π –∏–∑ –∏–Ω–¥–µ–∫—Å–∞**

```python
# –ò–Ω–¥–µ–∫—Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
idx = IndexDF(pd.DataFrame({
    "post_id": [1, 2, 3, ..., 100],
    "user_id": [100, 101, 100, 102, ...]  # ~10 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö user_id
}))

# –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ user_id
unique_user_ids = idx["user_id"].unique()
# ‚Üí [100, 101, 102, 103, 104, 105, 106, 107, 108, 109]
```

**–®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å**

```python
# –ú–∞–ø–ø–∏–Ω–≥: posts.user_id ‚Üí profiles.id
filtered_idx = IndexDF(pd.DataFrame({
    "id": [100, 101, 102, 103, 104, 105, 106, 107, 108, 109]
}))
```

**–®–∞–≥ 3: –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∑–∞–ø–∏—Å–∏**

```python
# –ß–∏—Ç–∞–µ–º –¢–û–õ–¨–ö–û 10 –ø—Ä–æ—Ñ–∏–ª–µ–π –≤–º–µ—Å—Ç–æ 10 –º–ª–Ω!
profiles_data = profiles_table.get_data(filtered_idx)
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
if inp.join_keys:
    # –ò–∑–≤–ª–µ—á—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ user_id –∏–∑ idx
    filtered_idx_data = {}
    for idx_col, dt_col in inp.join_keys.items():
        if idx_col in idx.columns:
            filtered_idx_data[dt_col] = idx[idx_col].unique()

    # –°–æ–∑–¥–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å
    filtered_idx = IndexDF(pd.DataFrame(filtered_idx_data))
    data = inp.dt.get_data(filtered_idx)  # –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∑–∞–ø–∏—Å–∏!
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–∑ filtered join
- **–ß–∏—Ç–∞–µ—Ç—Å—è:** 10,000,000 –∑–∞–ø–∏—Å–µ–π
- **–ü–∞–º—è—Ç—å:** ~1 GB (–ø—Ä–∏ 100 –±–∞–π—Ç –Ω–∞ –∑–∞–ø–∏—Å—å)
- **–í—Ä–µ–º—è:** ~10 —Å–µ–∫—É–Ω–¥

### –° filtered join
- **–ß–∏—Ç–∞–µ—Ç—Å—è:** 10 –∑–∞–ø–∏—Å–µ–π
- **–ü–∞–º—è—Ç—å:** ~1 KB
- **–í—Ä–µ–º—è:** ~10 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ: 1000x** üöÄ

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```python
step = BatchTransformStep(
    name="process_posts",
    input_dts=[
        # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
        ComputeInput(
            dt=posts_table,
            join_type="full"
        ),

        # –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å filtered join
        ComputeInput(
            dt=profiles_table,
            join_type="inner",
            join_keys={"user_id": "id"}  # –í–∫–ª—é—á–∞–µ—Ç filtered join!
        ),
    ],
    transform_keys=["post_id"],
    use_offset_optimization=True
)
```

**–í–∞–∂–Ω–æ:** Filtered join –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `join_keys`.

---

## –ü—Ä–∏–º–µ—Ä

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```python
# –ò–Ω–¥–µ–∫—Å –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (100 –∑–∞–ø–∏—Å–µ–π)
idx = IndexDF(pd.DataFrame({
    "post_id": [1, 2, 3, ..., 100],
    "user_id": [100, 101, 100, 102, 100, 103, ...]
}))

# join_keys –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
join_keys = {"user_id": "id"}  # posts.user_id = profiles.id
```

### –ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```python
# 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö user_id
unique_user_ids = idx["user_id"].unique()
# [100, 101, 102, 103, 104, 105, 106, 107, 108, 109]  # 10 –∑–Ω–∞—á–µ–Ω–∏–π

# 2. –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ –∫–æ–ª–æ–Ω–∫—É profiles.id
filtered_idx_data = {"id": unique_user_ids}

# 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
filtered_idx = IndexDF(pd.DataFrame(filtered_idx_data))

# 4. –ß—Ç–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
profiles_data = profiles_table.get_data(filtered_idx)
# ‚Üí 10 –∑–∞–ø–∏—Å–µ–π –≤–º–µ—Å—Ç–æ 10,000,000
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

```python
# –ë–µ–∑ filtered join
profiles_data = profiles_table.get_data()  # 10 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: 1 GB

# –° filtered join
profiles_data = profiles_table.get_data(filtered_idx)  # 10 –∑–∞–ø–∏—Å–µ–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: 1 KB

# –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏: 99.9999%
```

---

## –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏

### –°–ª—É—á–∞–π 1: join_keys –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç –≤ –∏–Ω–¥–µ–∫—Å–µ

```python
join_keys = {"author_id": "id"}

# –ù–æ –≤ idx —Ç–æ–ª—å–∫–æ post_id, –Ω–µ—Ç author_id
idx = IndexDF(pd.DataFrame({"post_id": [1, 2, 3]}))

# Fallback: —á–∏—Ç–∞–µ—Ç—Å—è –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞
data = inp.dt.get_data()
```

### –°–ª—É—á–∞–π 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ join_keys

```python
join_keys = {"category_id": "id", "subcategory_id": "sub_id"}

# –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –æ–±–∞ –∫–ª—é—á–∞
filtered_idx_data = {
    "id": idx["category_id"].unique(),
    "sub_id": idx["subcategory_id"].unique(),
}

filtered_idx = IndexDF(pd.DataFrame(filtered_idx_data))
```

---

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

**‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –ë–æ–ª—å—à–∏–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (> 100k –∑–∞–ø–∏—Å–µ–π)
- –ú–∞–ª—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (< 10%)
- –ë–∞—Ç—á–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –∫–ª—é—á–µ–π

**‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ú–∞–ª—ã–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (< 10k –∑–∞–ø–∏—Å–µ–π)
- –ù—É–∂–Ω–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö (> 50%)
- –°—Ç–æ–∏–º–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –Ω–∏–∑–∫–∞—è

---

[‚Üê –ù–∞–∑–∞–¥ –∫ –æ–±–∑–æ—Ä—É](./offset-optimization.md)
